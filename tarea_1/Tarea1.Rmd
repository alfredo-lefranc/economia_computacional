---
title: 'Economía Computacional: Tarea 1'
author: "Isidoro Garcia"
date: '2021'
output: pdf_document
  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = F)
```

```{r liberias , message=FALSE}
library(tidyverse)
library(data.table)
library(RCT)
library(knitr)
library(lfe)
library(broom)
library(stargazer)
library(kableExtra)
library(naniar)
library(nnet)
```

En esta tarea pondrán en práctica los conceptos de High Dimensional Inference y Regresión. La base de datos muestra las compras de helados Ben & Jerry. Cada fila es una compra. Cada columna es una característica del helado comprado o de la persona que compró. 


## Limpieza de datos

Carga los datos en BenAndJerry.csv. 

```{r }
# Carga la base de datos
base<-read.csv("BenAndJerry.csv")
```


### 1. Cuales son las columnas de la base? Muestra una tabla con ellas
```{r }
columnas <- (as.data.frame(colnames(base)))

kable(columnas, booktabs=T, align = 'c', col.names = c("Columnas"))
```

### 2. A qué nivel está la base? Esto es, cuál es la variable que define la base de manera única. Si no la hay, crea una y muestra que es única a nivel de la base (Muestra el código)

Así como está la base sin niguna modificación el nivel es la compra. Es decir, cada fila representa una transacción realizada por un hogar. Esto lo podriamos modificar para que la unidad sea el hogar o cualquier otra variable.

No hay una variable explícita que identifique cada observación de manera única pero si hay una manera implícita y es el índice de cada fila. Sin embargo, podemos crear una variable que contenga la información del índice de fila.


```{r}
base<- base %>% rowid_to_column("ID")
```


### 3. Que variables tienen valores vacíos? Haz una tabla con el porcentaje de vacíos para las columnas que tengan al menos una observación vacía

````{r}
kable( (base %>% select_if(~sum(is.na(.)) > 0) %>% miss_var_summary()), booktabs=T, align = 'c', col.names = c("Variable","Cantidad","%"))
```

### 4. Haz algo con los valores vacíos (Se deben reemplazar por algún valor? Eliminar de la base?). Justifica tu respuesta. 

Pues dependiendo de la cantidad de valores vacíos, de si hay un patrón en los valores vacíos y las características de cada variable podemos proponer una estrategia, por ejemplo imputación o quitar esas observaciones. En este sentido tenemos que realizar un análisis por variable:

**promotion_type**
````{r}
summary(factor(base$promotion_type))
```
En esta variable podría ser que los NAs nos indiquen que sencillamente no hubo ninguna promoción (y eso podría explicar que casi el 60% de sus valores sean NAs). En este caso podemos suponer eso e imputarle un valor de 5 o 0 a cada Na.

````{r}
base$promotion_type[is.na(base$promotion_type)] <- 0
```

**scantrack_market_identifier**

````{r}
summary(factor(base$scantrack_market_identifier))

```

````{r}
susp<-base%>% select(fips_state_code,fips_county_code,type_of_residence,scantrack_market_identifier)

```


En este caso es más complejo porque es muy probable que cada valor corresponda a un producto, a una clasificación de cliente o a cualquier otra cosa. En este caso, lo que podríamos hacer es ver si podemos inferir está información de otras varaibles, de lo contrario imputar sería una muy mala idea pues estaríamos creando ruido en nuestra información. Investigando un poco nos dimos cuenta que se trata de una clasificación del posicionamiento en el mercado.

**female_head_occupation**

````{r}

aux<-base %>% select(female_head_occupation,female_head_education,female_head_employment)%>%
  filter (is.na(female_head_occupation))
aux$female_head_education<-as.factor(aux$female_head_education)
aux$female_head_employment<-as.factor(aux$female_head_employment)

summary((aux))

```

Notamos que todas las observaciones con valor faltante coinciden con los valores 0 de las columnas female_head_employment y female_head_education. Es muy probable que sean mujeres sin ocupación (tal vez ama de casa no lo están contemplando como ocupación). En este sentido crear una nueva categoría de mujeres con estás características con el número de 0 la cuál imputaremos a los valores faltantes.


````{r}
base$female_head_occupation[is.na(base$female_head_occupation)] <- 0

```

**tv_items**

En este caso, puede que la variable indíque una cantidad de *items* o bien que indique una categoría. En el caso primero, parecería que no contemplaron una cantidad de 0s o de más de 3, bien podríamos imputar el valor de 0. En el segundo caso, no tenemos manera de saber que tipo de categorías son, en ese caso no podríamos imputar tan facilmente: podríamos agregar un valor para identificarlas (como un 0) o bien simplemente prescindir de dichas observaciones (lo cuál no afectaría nuestro análisis debido a que son tan solo 34 observaciones).


````{r}
summary(factor(base$tv_items))

```

### 5. Muestra una tabla de estadisticas descriptivas de la base. Esta debe tener cada columna númerica con algunas estadísticas descriptivas (N, media, min, p05, p25, p50, p75, p90, p95, max). 

Sin hacer ninguna adecuación en el tipo de variables, la tabla es la siguiente:

````{r}

b<- summary_statistics(base,probs=c(0,0.05,0.25,0.5,0.75,0.9,0.95,1),na.rm=T)
b<- b %>% mutate_at(vars(-variable),funs(round(.,2))) %>%
  rename(mín=4) %>%
  rename(máx=11)
kable(b,booktabs=T, align = 'c')


```


### 6. Hay alguna númerica que en verdad represente una categorica? Cuales? Cambialas a factor

Sin duda las siguientes variables son categóricas: *male_head_employment.female_head_employment,marital_status,male_head_occupation,female_head_occupation,household_composition,race,hispanic_origin,region,scantrack_market_identifier,fips_state_code,fips_county_code,type_of_residence, household_internet_connection*.

Sin embargo, las siguientes podrían ser o no ser categóricas, tendríamos que hacer un breve análisis para determinar: *tv_items,kitchen_appliances,age_and_presence_of_children,male_head_education,female_head_education.*



````{r}
variables_seguras<-c("male_head_employment","female_head_employment","marital_status","male_head_occupation","female_head_occupation","household_composition","race","hispanic_origin","region","scantrack_market_identifier","fips_state_code","fips_county_code","type_of_residence","household_internet_connection")

variables_no_seguras<-c("tv_items","kitchen_appliances","age_and_presence_of_children","male_head_education","female_head_education")

base[,variables_seguras] <- lapply(base[,variables_seguras] , factor)
base[,variables_no_seguras] <- lapply(base[,variables_no_seguras] , factor)

summary(base[,variables_no_seguras])

```

Parece que *tv_items, kitchen_appliances, age_and_presence_of_children* no son categóricas después de todo. Las regresamos a numéricas otra vez, Por el contrario *male_head_education* y *female_head_education* parece que sí son categóricas.

````{r}
variables_numericas<-c("tv_items","kitchen_appliances","age_and_presence_of_children")
base[,variables_numericas] <- lapply(base[,variables_numericas] , as.numeric)
```


### 7. Revisa la distribución de algunas variables. Todas tienen sentido? Por ejemplo, las edades? 

````{r}
numericas<-base%>% select(where(is.numeric))
names(numericas) <- names(numericas)
lapply(numericas,hist)

```

FALTA ANALISIS


### 8. Finalmente, crea una variable que sea el precio total pagado y el precio unitario
````{r}
# precio total pagado
base <- base %>% mutate(total_price=price_paid_deal+price_paid_non_deal)
# precio unitario
base <- base %>% mutate(unit_price= (total_price)/quantity)
```


## Exploración de los datos 

Intentaremos comprender la elasticidad precio de los helados. Para ello, debemos entender: 

- La forma funcional base de la demanda (i.e. como se parecen relacionarse $q$ y $p$). 

- Qué variables irían en el modelo de demanda y cuáles no para encontrar la elasticidad de manera 'insesgada'. 

- Qué variables cambian la relacion de $q$ y $p$. Esto es, que variables alteran la elasticidad.

Algo importante es que siempre debemos mirar primero las variables más relevantes de cerca y su relación en: 

- Relación univariada

- Relaciones bivariadas

- Relaciones trivariadas

Importante: Las gráficas deben estar bien documentadas (título, ejes con etiquetas apropiadas, etc). Cualquier gráfica que no cumpla con estos requisitos les quitaré algunos puntos.

### 9. Cómo se ve la distribución del precio unitario y de la cantidad demandada. Haz un histograma.
````{r}
median_price <- quantile(base$unit_price)[3]

ggplot(base)+
  geom_histogram(aes(x=unit_price),alpha=0.9,col = 'black')+
  geom_vline(xintercept = median_price,size=0.5,colour="red", linetype = "dashed")+
  geom_text(aes(x=median_price+2.8, label=paste("Mediana =",median_price), y=4800),size=4, colour="red", vjust = -1, hjust = 1.2)+
  theme_bw()+
  labs(title="Histograma de precio unitario",x="Precio unitario",y="Frecuencia")

  
ggplot(base)+
  geom_histogram(aes(x=quantity),binwidth=1,alpha=0.9,col = 'black')+
  theme_bw()+
  labs(title="Histograma de cantidad",x="Cantidad",y="Frecuencia")

```

### 10. Grafica la $q(p)$. Que tipo de relación parecen tener? 

Aunque parece haber una relación negativa, esta no es tan clara.

````{r}
ggplot(base)+
  geom_point(aes(x=quantity,y=unit_price))+ 
  geom_smooth(formula=y~x,method=lm, color='1',aes(x = quantity, y = unit_price))
```

### 11. Grafica la misma relación pero ahora entre $log(p+1)$ y $log(q+1)$

Cuando hacemos la transformación, la relación es más evidente:

````{r}
ggplot(base)+
  geom_point(aes(x=log(quantity+1),y=log(unit_price+1)))+ 
  geom_smooth(formula=y~x,method=lm, color='1',aes(x = log(quantity+1), y = log(unit_price+1)))

```

### 12. Grafica la curva de demanda por tamaño del helado. Parece haber diferencias en la elasticidad precio dependiendo de la presentación del helado? (2 pts)

````{r}

ggplot(data = base, aes(x=quantity, y=unit_price,col=as.factor(size1_descr))) +
  geom_point() +
  geom_smooth(method='lm',
              formula= y~(x),
              se=FALSE, size=2)
````
HACER UNA PRUEBA DE HIPOTESIS

### 13. Grafica la curva de demanda por sabor. Crea una variable con los 3 sabores más populares y agruga el resto de los sabores como 'otros'. Parece haber diferencias en la elasticidad precio dependiendo del sabor?
````{r}
summary(factor(base$flavor_descr))
```

Parece que los 3 sabores más populares son *CHERRY GRCA*, *CHC FUDGE BROWNIE* y *CHC CHIP C-DH*.

````{r}
base<-base%>% mutate(sabores_pop= ifelse(flavor_descr=='CHERRY GRCA','CHERRY GRCA',
(ifelse(flavor_descr=='CHC FUDGE BROWNIE','CHC FUDGE BROWNIE',
(ifelse(flavor_descr=='CHC CHIP C-DH','CHC CHIP C-DH','otros'))))))


ggplot(data = base, aes(x=quantity, y=unit_price,col=as.factor(sabores_pop))) +
  geom_point() +
  geom_smooth(method='lm',
              formula= y~(x),
              se=FALSE, size=2)
```
PRUEBA DE HIPOTESIS

## Estimación

### 14. Estima la regresión de la curva de demanda de los helados. Reporta la tabla de la regresión
````{r, results= 'asis'}
model_a<-lm(unit_price~quantity,data = base)
stargazer(model_a, type = "latex", title="Regresión", digits=1)
```
CORREGIR

Algunos tips: 

- No olvides borrar la variable que recien creamos de sabores. Incluirla (dado que es perfectamente colineal con flavor), sería una violación a supuesto GM 3 de la regresión. 

- No olvides quitar `quantity`, `price_unit`, `price_deal` y otras variables que sirven como identificadora. Tambien quitar `fips_state_code` y `fips_county_code`.

- Empecemos con una regresión que incluya a todas las variables. 


Nota: La regresión en `R` entiende que si le metes variables de texto, debe convertirlas a un factor. En algunos otros algoritmos que veremos durante el curso, tendremos que convertir manualmente toda la base a una númerica. 

Quitemos las fechas
```{r}
base$female_head_birth<-NULL
base$male_head_birth<-NULL
```

### 15 (2 pts). Cuales son los elementos que guarda el objecto de la regresión? Listalos. Cual es el F-test de la regresión? Escribe la prueba de manera matemática (i.e. como la vimos en clase). (Tip: `summary(fit)` te arroja algo del F-test)
````{r}
(names(model_a))

glance(model_a)

RSS <- sum(model_a$residuals^2)
TSS<- sum((base$unit_price-mean(base$unit_price))^2)
n<- length(base$unit_price)
k<- 1

(F <- ((TSS-RSS)/k)/(RSS/(n-k-1)))

summary(model_a)
# sí es igual
```

### 16. Cuál es la elasticidad precio de los helados Ben and Jerry ? Es significativo? Interpreta el coeficiente 
````{r}

```

## 17. Cuántos p-values tenemos en la regresión. Haz un histograma de los p-values. 
````{r}

```


### 18 (4pts). Realiza un ajuste FDR a una $q=0.10$. Grafica el procedimiento (con y sin zoom-in a p-values<0.05). Cuantas variables salían significativas con $\alpha = 0.05$? Cuantas salen con FDR? 
Tip: crea el ranking de cada p-value como `resultados %>% arrange(p.value) %>% mutate(ranking = row_number)`
````{r}

```

### 19 (2pts). Repite el ejercicio pero ahora con Holm-Bonferroni. Comparalo vs FDR. En este caso cuantas variables son significativas?  Haz la grafica comparativa (solo con zoom-in)
````{r}

```
